<!DOCTYPE html>
<html>
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Ecto Model Schema Extension</title>
    <meta name="description" content="NectarCommerce - Quest for customizable E-commerce - the Elixir way" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/nectarcommerce/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/nectarcommerce/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/nectarcommerce/assets/css/syntax.css" />
    
    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/nectarcommerce/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/nectarcommerce/page2/" />

    <meta property="og:site_name" content="NectarCommerce" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="NectarCommerce" />
    <meta property="og:description" content="Quest for customizable E-commerce - the Elixir way" />
    <meta property="og:url" content="/nectarcommerce/" />
    <meta property="og:image" content="/nectarcommerce/assets/images/general-cover.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="NectarCommerce" />
    <meta name="twitter:description" content="Quest for customizable E-commerce - the Elixir way" />
    <meta name="twitter:url" content="/nectarcommerce/" />
    <meta name="twitter:image:src" content="/nectarcommerce/assets/images/general-cover-1.png" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "NectarCommerce",
    "url": "/nectarcommerce/",
    "image": "/nectarcommerce/assets/images/general-cover.png",
    "description": "Quest for customizable E-commerce - the Elixir way"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="NectarCommerce" href="/nectarcommerce/rss.xml" />


</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/nectarcommerce/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/nectarcommerce/about">About</a></li>
        <li class="nav-author " role="presentation"><a href="/nectarcommerce/author/pikender">Author</a></li>
    </ul>
    <!-- <a class="subscribe-button icon-feed" href="/nectarcommerce/rss.xml">Subscribe</a> -->
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/nectarcommerce/assets/images/general-cover-3.jpg) ">
    <a id="forkme_banner" href="https://github.com/vinsol/nectarcommerce"></a>
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/nectarcommerce/"><img src="/nectarcommerce/assets/images/nectar-cart.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-docs">

        <header class="post-header">
            <h1 class="post-title">Ecto Model Schema Extension</h1>
            <section class="post-meta">
            <!-- <a href='/nectarcommerce/'>Pikender Sharma</a> -->
            <time class="post-date" datetime="2016-04-12">12 Apr 2016</time>
                <!-- [[tags prefix=" on "]] -->
                 
                on 
                
                    
                       <a href='/nectarcommerce/tag/docs'>Docs</a>
                       
                
                
            </section>
        </header>

        <section class="post-content">

            <blockquote>

  <p>The post belongs to <em>NectarCommerce and Extension Framework Awareness</em> Series</p>

  <ol>
    <li><em><a href="http://vinsol.com/blog/2016/04/08/nectarcommerce-vision/">NectarCommerce Vision</a></em></li>
    <li><em><a href="http://vinsol.com/blog/2016/04/12/extension-framework-game-plan/">Extension Framework Game Plan</a></em></li>
    <li>Introduction to Writing Macros</li>
    <li><strong>Ecto Model Schema Extension</strong></li>
    <li>Ecto Model Support Functions Extension</li>
    <li>Phoenix Router Extension</li>
    <li>Phoenix View Extension</li>
    <li>Running Multiple Elixir Apps Together</li>
    <li>Extension Approach Explained</li>
    <li>Developer Experience and Workflow developing Favorite Product Extension</li>
    <li>Developer Experience and Workflow testing Favorite Product Extension</li>
  </ol>
</blockquote>

<h2 id="what-will-be-nectarcommerce">What will be NectarCommerce</h2>

<blockquote>

  <p>Off-the-shelf Opensource E-commerce application for building online store.</p>

  <p>Provides an Extension Framework to support features not included in core as extensions.</p>

  <p>Strives for un-obstrusive parallel development of NectarCommerce and Extensions</p>
</blockquote>

<p>NectarCommerce is committed to providing a ready-to-use e-commerce solution but the definition of 100% is different under different business domains. It aims to solve common use-cases as part of the project and relying on extension framework to tap the rest.</p>

<h1 id="ecto-model-schema-extension">Ecto Model Schema Extension</h1>

<h3 id="why">Why</h3>

<p>We want to allow Extensions to modify schema of existing Nectar Models without changing the Nectar Models.</p>

<p>Extensions should be able to add new fields and associations to existing models as needed for the cause.</p>

<h3 id="how">How</h3>

<p>There are three parts needed at minimium to create &amp; use an extension effectively:</p>

<ul>
  <li>Library Code</li>
  <li>Service Code</li>
  <li>Consumer Code</li>
</ul>

<p>An extension and its use with Nectar can be viewed as Producer / Consumer relationship bound by a communication protocol.</p>

<p><strong>Extension</strong> which want to add a virtual field, say special, to Nectar Product Model Schema is a <strong>Producer (Service Code)</strong>.</p>

<p><strong>Nectar Model</strong> is a <strong>Consumer (Consumer Code)</strong> allowing the schema changes through a <strong>communication protocol (Library Code)</strong></p>

<p>Let’s begin the journey of incremental changes to bring consumer, service and library code into existence starting from a simple use-case of adding a virtual boolean field, say special to Nectar Product.</p>

<blockquote>

  <p>Note: Please refer <a href="">Intro to Metaprogramming</a> for more information on Metaprogramming in Elixir</p>
</blockquote>

<ol>
  <li>
    <p>Straightforward way to add virtual field, say special, to Nectar Product would be to add it directly in Nectar.Product Schema definition, but it requires change in Nectar source. Let’s move to next step for the workaround to avoid modification to Nectar.Product</p>

    <script src="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/2faba2e7a14bb77cceec769ef676fd439244878d.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>We can add a function to Nectar Model Schema to which other extensions can delegate the reponsibility of schema changes, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/5f4ada57be942f8dce713cf4c6c0d6761a7632a0">here</a>. See Nectar.ExtendProduct example below on how to use it.</p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/867502fb2218c41b6495bf318fab527a8a185193.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>Now, with delegation function <code class="highlighter-rouge">extensions</code> in place, we can work towards providing a way to register the schema changes, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/d2b931acb891d74014d2c5f6a1996f69c222e01c">here</a>. Please check the usage of Module attributes for same below.</p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/51619c29cf3a741c85b64e8e6e6ee254457393c5.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>Earlier, Module.put_attribute need to be used multiple times to define multiple routes instead we wrapped it in an anonymous function to encapsulate the collection of schema changes through a simple and consistent interface, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/3312acebeb9edec66e61da2ad447f7b18d5a9c8e">here</a>. There can be multiple extensions used for different functionality and hence multiple schema changes need to be registered and defined</p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/a1390db765a519334926834da392db90b70a2e84.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>Now, Nectar.ExtendProduct is getting cluttered with ancillary method definitions, lets move it out to another module and use it, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/4d3d831a6541e1e0c8ffeca4bbf44fbff579da35">here</a></p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/3323216f040a457e2a23dab6715be545dfa001e6.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>Let’s further reduce the boilerplate of registering schema_changes module attribute and importing include_method method definition with <strong>using</strong> callback, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/3e16ffe09593e53a8ca598df821dd260f92c4856">here</a></p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/bce26efc97a14745007ed06a2bf29c52e95965af.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>Reference of schema_changes Module attribute is scattered across Nectar.ExtendProduct and Nectar.ModelExtension so lets move it out to Nectar.ModelExtension to consolidate the usage via <code class="highlighter-rouge">__before_compile__</code> and definition together, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/3f09764e15098234e8b8d43361d403a4e8d370a2">here</a></p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/abd73fd87467c23c6d8a9ab262cc50306356f3d7.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
  <li>
    <p>With above changes, it’s now possible to define schema changes any number of times needed, see full version <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1">here</a>. Also, schema changes can now be added using <code class="highlighter-rouge">include_method</code> in Nectar.ExtendProduct without making any changes to Nectar.Product.</p>

    <script src="https://gist.github.com/pikender/cb43c04937fbb95b289bfa43d8dfab08/518fae3a31366e82b12270cf8d60139dff86b3a4.js"></script>

    <script src="https://gist.github.com/pikender/bf89a77d2ed7c684dd0258d88e777cc0.js"></script>
  </li>
</ol>

<p>To check all the revisions at once, please check <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1/revisions">here</a></p>

<p>Now, in the <a href="https://gist.github.com/pikender/f58b2208ae8951c7b13214bf320e8ec1">last version</a>, you can easily find the three components, <em>consumer, service and library code</em>, as desired in extensible system</p>

<p><em>Our aim with these posts is to start a dialog with the Elixir community on validity and technical soundness of our approach. We would really appreciate your feedback and reviews, and any ideas/suggestions/pull requests for improvements to our current implementation or entirely different and better way to do things to achieve the goals we have set out for NectarCommerce.</em></p>

<p><em>Enjoy the Elixir potion !!</em></p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            

            <section class="author">
                <h4><a href="/nectarcommerce/author/pikender">Pikender Sharma</a></h4>

                
                    <p> In search of salvation through technology</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> New Delhi, India</span> 
                    <span class="author-link icon-link"><a href="http://vinsol.github.io/nectarcommerce/"> vinsol.github.io/nectarcommerce/</a></span> 
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Ecto Model Schema Extension&amp;url=http://vinsol.github.io/nectarcommerce/ecto-model-schema-extension"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://vinsol.github.io/nectarcommerce/ecto-model-schema-extension"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://vinsol.github.io/nectarcommerce/ecto-model-schema-extension"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            
            <!-- Add Disqus Comments -->
            
            
        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/nectarcommerce/assets/images/general-cover-3.jpg)" href="/nectarcommerce/vision">
            <section class="post">
                <h2>NectarCommerce Vision</h2>
                <p>The post belongs to NectarCommerce and Extension Framework Awareness Series NectarCommerce Vision Extension Framework Game...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/nectarcommerce/">NectarCommerce</a> &copy; 2016</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/nectarcommerce/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/nectarcommerce/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
    
</body>
</html>
